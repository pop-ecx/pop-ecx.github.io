<link rel=stylesheet href=/css/custom.css><!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.111.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>Writing Custom Wazuh Rules &#183; pop-ecx</title><meta name=description content><link type=text/css rel=stylesheet href=https://pop-ecx.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://pop-ecx.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://pop-ecx.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://pop-ecx.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><script src=https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js></script>
<script>function addDarkmodeWidget(){new Darkmode({label:"ðŸŒ“",saveInCookies:!0,autoMatchOsTheme:!0,bottom:"32px",right:"32px",time:"0.3s",mixColor:"#fff",backgroundColor:"#fff"}).showWidget()}window.addEventListener("load",addDarkmodeWidget)</script></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=author-image><img src=/images/me.png alt="Author Image" class=author-image></div><div class=sidebar-about><a href=https://pop-ecx.github.io/><h1>pop-ecx</h1></a><p class=lead>Tech musings</p></div><div class=social-links><a href=https://github.com/pop-ecx target=_blank rel="noopener noreferrer"><img src=https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/github.svg width=24 height=24 alt=GitHub></a>
<a href=https://keybase.io/oliver_m target=_blank rel="noopener noreferrer"><img src=https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/keybase.svg width=24 height=24 alt=Keybase></a>
<a href=https://bsky.app/profile/pop-ecx.bsky.social target=_blank rel="noopener noreferrer"><img src=https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/bluesky.svg width=24 height=24 alt=Bluesky></a>
<a href=https://www.linkedin.com/in/oliver-mulwa target=_blank rel="noopener noreferrer"><img src=https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg width=24 height=24 alt=LinkedIn></a></div><nav><ul class=sidebar-nav><li><a href=https://pop-ecx.github.io/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/about/>About</a></li></ul></nav><p>&copy; 2026. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Writing Custom Wazuh Rules</h1><time datetime=2026-01-22T15:48:20+0300 class=post-date>Thu, Jan 22, 2026</time><p><a href=https://wazuh.com/>Wazuh</a> is a powerful open-source security monitoring platform that acts as a SIEM/XDR
solution. Though it has some <a href=https://zaferbalkan.com/wazuh-pain-points/>shortcomings</a>, it has tons of strengths, my favorite
ones being; its customizability and its open-source nature. This article will be
more or less a tutorial on how to write a simple custom wazuh rule to detect potential
port scans on a monitored host.</p><p>The setup is as follows:</p><ul><li>Wazuh manager (4.14.1) running on a Linux VM.</li><li>Wazuh agent (4.14.1) running on a Linux VM.</li></ul><h2 id=prologue>Prologue</h2><p>Before we start, we are going to use sysmon to generate some logs on the agent.
To install sysmon for Linux, follow the instructions <a href=https://github.com/microsoft/SysmonForLinux/blob/main/INSTALL.md>here</a>
and make sure it is sending logs either to syslog or perhaps via journald.</p><h2 id=tweaking-the-wazuh-agent>Tweaking the Wazuh agent</h2><p>First, we need to make sure wazuh agent is collecting sysmon logs. To do this,
check for the following configuration in <code>/var/ossec/etc/ossec.conf</code> on the agent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;localfile&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;log_format&gt;</span>syslog<span style=color:#f92672>&lt;/log_format&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;location&gt;</span>/var/log/syslog<span style=color:#f92672>&lt;/location&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/localfile&gt;</span>
</span></span></code></pre></div><p>If you are using journald, you can use the following configuration instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;localfile&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;log_format&gt;</span>journald<span style=color:#f92672>&lt;/log_format&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;location&gt;</span>/var/log/journal<span style=color:#f92672>&lt;/location&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/localfile&gt;</span>
</span></span></code></pre></div><blockquote><p>From here on, we&rsquo;ll assume syslog is being used.</p></blockquote><p>After making the changes restart the wazuh-agent service, then generate some syslogs by running
nmap against the agent machine. You can grep for eventId 3 which indicates a network connection
event:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo grep -i <span style=color:#e6db74>&#34;&lt;EventID&gt;3&#34;</span> /var/log/syslog
</span></span></code></pre></div><p>If you get hits, move on to the next step.</p><h2 id=writing-custom-decoder>Writing custom decoder</h2><p>Next, we need to write a custom decoder to parse the sysmon logs. You can edit the file
<code>/var/ossec/etc/decoders/local_decoder.xml</code> on the manager and add the following decoder:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;decoder</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;sysmon-linux&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;program_name&gt;</span>sysmon<span style=color:#f92672>&lt;/program_name&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/decoder&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;decoder</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;sysmon-linux&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;parent&gt;</span>sysmon-linux<span style=color:#f92672>&lt;/parent&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;prematch&gt;</span>SourceIp<span style=color:#f92672>&lt;/prematch&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;regex</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;pcre2&#34;</span> <span style=color:#a6e22e>offset=</span><span style=color:#e6db74>&#34;after_prematch&#34;</span><span style=color:#f92672>&gt;</span>([0-9a-fA-F:.]+)<span style=color:#f92672>&lt;/regex&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;order&gt;</span>srcip<span style=color:#f92672>&lt;/order&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/decoder&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;decoder</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;sysmon-linux&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;parent&gt;</span>sysmon-linux<span style=color:#f92672>&lt;/parent&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;regex&gt;</span>EventID&gt;(\d+)<span style=color:#f92672>&lt;/regex&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;order&gt;</span>id<span style=color:#f92672>&lt;/order&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/decoder&gt;</span>
</span></span></code></pre></div><p>Wazuh uses XML files for decoders, and the above decoder will extract the source IP
address and event ID from sysmon logs. Those fields will be used in the custom rule.</p><blockquote><p>Wazuh uses various kinds of regex engines, including os regex. In this case we are using pcre2.
I had a bit of a tough time tweaking my regex to wazuh&rsquo;s liking since os regex engine is a bit
limited. In the end, I settled for pcre2.</p></blockquote><h2 id=writing-custom-rule>Writing custom rule</h2><p>Now we can move on to the custom rule. We&rsquo;ll edit the file
<code>/var/ossec/etc/rules/local_rules.xml</code> on the manager and add the following rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;group</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;linux,sysmon,&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;rule</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;100200&#34;</span> <span style=color:#a6e22e>level=</span><span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;decoded_as&gt;</span>sysmon-linux<span style=color:#f92672>&lt;/decoded_as&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;id&gt;</span>^3$<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;description&gt;</span>Sysmon Event ID 3 - Network connection<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;group&gt;</span>sysmon_event3,<span style=color:#f92672>&lt;/group&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;rule</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;100300&#34;</span> <span style=color:#a6e22e>level=</span><span style=color:#e6db74>&#34;12&#34;</span> <span style=color:#a6e22e>frequency=</span><span style=color:#e6db74>&#34;4&#34;</span> <span style=color:#a6e22e>timeframe=</span><span style=color:#e6db74>&#34;12&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;if_matched_group&gt;</span>sysmon<span style=color:#f92672>&lt;/if_matched_group&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;same_srcip&gt;</span>srcip<span style=color:#f92672>&lt;/same_srcip&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;description&gt;</span>Possible port scan detected from $(srcip)<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;group&gt;</span>sysmon_event3,port_scan,<span style=color:#f92672>&lt;/group&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/group&gt;</span>
</span></span></code></pre></div><p>The first rule (id 100200) is a base rule that matches sysmon event ID 3. The second
(id 100300) is the actual port scan detection rule. It is a correlation rule that triggers
if it sees 4 or more event ID 3 logs from the same source IP within a 12 second
timeframe. When triggered, it raises the alert level to 12 and generates an alert indicating
a possible port scan.</p><p>Once done you can locally test the rules using the <code>wazuh-logtest</code> utility on the manager</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/var/ossec/bin/wazuh-logtest
</span></span></code></pre></div><p>and enter one of the sysmon logs. If everything went well, you should see this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>**Phase 1: Completed pre-decoding.
</span></span><span style=display:flex><span>	full event: <span style=color:#e6db74>&#39;Jan 22 16:17:16 testserver sysmon: &lt;Event&gt;&lt;System&gt;&lt;Provider Name=&#34;Linux-Sysmon&#34; Guid=&#34;{ff032593-a8d3-4f13-b0d6-01fc615a0f97}&#34;/&gt;&lt;EventID&gt;3&lt;/EventID&gt;&lt;Version&gt;5&lt;/Version&gt;&lt;Level&gt;4&lt;/Level&gt;&lt;Task&gt;3&lt;/Task&gt;&lt;Opcode&gt;0&lt;/Opcode&gt;&lt;Keywords&gt;0x8000000000000000&lt;/Keywords&gt;&lt;TimeCreated SystemTime=&#34;2026-01-22T13:17:16.405709000Z&#34;/&gt;&lt;EventRecordID&gt;62099&lt;/EventRecordID&gt;&lt;Correlation/&gt;&lt;Execution ProcessID=&#34;4107731&#34; ThreadID=&#34;4107731&#34;/&gt;&lt;Channel&gt;Linux-Sysmon/Operational&lt;/Channel&gt;&lt;Computer&gt;testserver&lt;/Computer&gt;&lt;Security UserId=&#34;0&#34;/&gt;&lt;/System&gt;&lt;EventData&gt;&lt;Data Name=&#34;RuleName&#34;&gt;-&lt;/Data&gt;&lt;Data Name=&#34;UtcTime&#34;&gt;2026-01-22 13:17:16.412&lt;/Data&gt;&lt;Data Name=&#34;ProcessGuid&#34;&gt;{fd88a264-6181-6936-5d32-072e16560000}&lt;/Data&gt;&lt;Data Name=&#34;ProcessId&#34;&gt;2756479&lt;/Data&gt;&lt;Data Name=&#34;Protocol&#34;&gt;tcp&lt;/Data&gt;&lt;Data Name=&#34;Initiated&#34;&gt;true&lt;/Data&gt;&lt;Data Name=&#34;SourceIsIpv6&#34;&gt;false&lt;/Data&gt;&lt;Data Name=&#34;SourceIp&#34;&gt;192.168.2.2&lt;/Data&gt;&lt;Data Name=&#34;SourceHostname&#34;&gt;-&lt;/Data&gt;&lt;Data Name=&#34;SourcePort&#34;&gt;37678&lt;/Data&gt;&lt;Data Name=&#34;SourcePortName&#34;&gt;-&lt;/Data&gt;&lt;Data Name=&#34;DestinationIsIpv6&#34;&gt;false&lt;/Data&gt;&lt;Data Name=&#34;DestinationIp&#34;&gt;192.168.2.3&lt;/Data&gt;&lt;Data Name=&#34;DestinationHostname&#34;&gt;-&lt;/Data&gt;&lt;Data Name=&#34;DestinationPort&#34;&gt;3307&lt;/Data&gt;&lt;Data Name=&#34;DestinationPortName&#34;&gt;-&lt;/Data&gt;&lt;/EventData&gt;&lt;/Event&gt;&#39;</span>
</span></span><span style=display:flex><span>	timestamp: <span style=color:#e6db74>&#39;Jan 22 16:17:16&#39;</span>
</span></span><span style=display:flex><span>	hostname: <span style=color:#e6db74>&#39;testserver&#39;</span>
</span></span><span style=display:flex><span>	program_name: <span style=color:#e6db74>&#39;sysmon&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**Phase 2: Completed decoding.
</span></span><span style=display:flex><span>	name: <span style=color:#e6db74>&#39;sysmon-linux&#39;</span>
</span></span><span style=display:flex><span>	parent: <span style=color:#e6db74>&#39;sysmon-linux&#39;</span>
</span></span><span style=display:flex><span>	id: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>	srcip: <span style=color:#e6db74>&#39;192.168.2.2&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**Phase 3: Completed filtering <span style=color:#f92672>(</span>rules<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>	id: <span style=color:#e6db74>&#39;100200&#39;</span>
</span></span><span style=display:flex><span>	level: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>	description: <span style=color:#e6db74>&#39;Sysmon Event ID 3 - Network connection&#39;</span>
</span></span><span style=display:flex><span>	groups: <span style=color:#e6db74>&#39;[&#34;linux&#34;,&#34;sysmon&#34;,&#34;sysmon_event3&#34;]&#39;</span>
</span></span><span style=display:flex><span>	firedtimes: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>	mail: <span style=color:#e6db74>&#39;false&#39;</span>
</span></span></code></pre></div><p>If you are using the web interface, if you send the logs repeatedly (4 or more times)
you will see the port scan alert being triggered.</p><h2 id=epilogue>Epilogue</h2><p>Now to test it, run nmap or rustscan against the agent and see alerts on the dashboard.</p><blockquote><p>This tutorial is a basic example and did not take into account the nuances of
real-world port scans. Also, regex is this horrible thing Satan uses to torment us mortals.</p></blockquote><p><a href=https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html#if-matched-group>Wazuh ruleset xml syntax reference</a></p><p><a href=https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/decoders.html>Wazuh decoders syntax reference</a></p><p><a href=https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/regex.html>Wazuh regex reference</a></p><p><a href=https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/pcre2.html>Wazuh pcre regex reference</a></p></div></main></body></html>